# æ ¸å¿ƒä»»åŠ¡å®æ–½è®¡åˆ’

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œä¸“æ³¨å®Œæˆä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒä»»åŠ¡ï¼š
1. **ç§»é™¤æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½**
2. **å®Œå–„å¾®ä¿¡æ”¯ä»˜å›è°ƒæ¥å£**
3. **å®Œå–„è¯„ä»·ç³»ç»Ÿå¼€å‘**

## ğŸ“‹ ä»»åŠ¡ä¸€ï¼šç§»é™¤æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½

### ğŸ” å½“å‰çŠ¶æ€åˆ†æ
- PaymentServiceImpl.alipay()æ–¹æ³•å­˜åœ¨ä½†æœªå®ç°
- PaymentTypeEnumåŒ…å«ALIPAYæšä¸¾
- å‰ç«¯å¯èƒ½æœ‰æ”¯ä»˜å®æ”¯ä»˜é€‰é¡¹

### âœ… å…·ä½“å®æ–½æ­¥éª¤

#### 1. åç«¯ä»£ç æ¸…ç†ï¼ˆ0.5å¤©ï¼‰
```java
// éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- expert/src/main/java/com/qing/expert/service/impl/PaymentServiceImpl.java
  - ç§»é™¤alipay()æ–¹æ³•å®ç°
  - åœ¨createPayment()ä¸­ç§»é™¤ALIPAYåˆ†æ”¯

- expert/src/main/java/com/qing/expert/enums/PaymentTypeEnum.java
  - ç§»é™¤ALIPAYæšä¸¾é¡¹

- expert/src/main/java/com/qing/expert/controller/user/UserPaymentController.java
  - ç§»é™¤æ”¯ä»˜å®å›è°ƒæ¥å£alipayCallback()
```

#### 2. å‰ç«¯ä»£ç æ¸…ç†ï¼ˆ0.5å¤©ï¼‰
```typescript
// éœ€è¦æ£€æŸ¥å’Œæ¸…ç†çš„æ–‡ä»¶ï¼š
- uniapp/Uni_expert/pages/order/payment.vue
- web/src/views/orders/payment.vue
- ç§»é™¤æ”¯ä»˜å®æ”¯ä»˜é€‰é¡¹å’Œç›¸å…³é€»è¾‘
```

## ğŸ“‹ ä»»åŠ¡äºŒï¼šå®Œå–„å¾®ä¿¡æ”¯ä»˜å›è°ƒæ¥å£

### ğŸ” å½“å‰çŠ¶æ€åˆ†æ
- WechatPayServiceImpl.handlePaymentNotify()æ–¹æ³•æ ‡è®°ä¸ºTODO
- ç¼ºå°‘APIv3å›è°ƒç­¾åéªŒè¯
- ç¼ºå°‘æ”¯ä»˜çŠ¶æ€åŒæ­¥æœºåˆ¶

### âœ… å…·ä½“å®æ–½æ­¥éª¤

#### 1. å®ç°å›è°ƒéªŒè¯é€»è¾‘ï¼ˆ1å¤©ï¼‰
```java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/service/impl/WechatPayServiceImpl.java

@Override
public boolean handlePaymentNotify(String jsonData) {
    try {
        // 1. è§£æå›è°ƒJSONæ•°æ®
        JSONObject notifyData = JSON.parseObject(jsonData);
        
        // 2. éªŒè¯å›è°ƒç­¾åï¼ˆä½¿ç”¨å¾®ä¿¡æ”¯ä»˜SDKï¼‰
        if (!verifyNotifySignature(jsonData)) {
            log.error("å¾®ä¿¡æ”¯ä»˜å›è°ƒç­¾åéªŒè¯å¤±è´¥");
            return false;
        }
        
        // 3. è§£ææ”¯ä»˜ç»“æœ
        String outTradeNo = notifyData.getString("out_trade_no");
        String transactionId = notifyData.getString("transaction_id");
        String tradeState = notifyData.getString("trade_state");
        
        // 4. æ›´æ–°æ”¯ä»˜çŠ¶æ€
        return updatePaymentStatus(outTradeNo, transactionId, tradeState);
        
    } catch (Exception e) {
        log.error("å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒå¤±è´¥", e);
        return false;
    }
}
```

#### 2. å®ç°æ”¯ä»˜çŠ¶æ€åŒæ­¥ï¼ˆ1å¤©ï¼‰
```java
// æ–°å¢æ–¹æ³•ï¼šupdatePaymentStatus()
private boolean updatePaymentStatus(String paymentNo, String transactionId, String tradeState) {
    // 1. æŸ¥è¯¢æ”¯ä»˜è®°å½•
    // 2. æ›´æ–°æ”¯ä»˜çŠ¶æ€
    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    // 4. å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
    // 5. è®°å½•äº¤æ˜“æµæ°´
}
```

#### 3. æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶ï¼ˆ0.5å¤©ï¼‰
```java
// æ·»åŠ å›è°ƒé‡è¯•æœºåˆ¶
// æ·»åŠ å¼‚å¸¸æƒ…å†µå¤„ç†
// æ·»åŠ æ—¥å¿—è®°å½•
```

## ğŸ“‹ ä»»åŠ¡ä¸‰ï¼šå®Œå–„è¯„ä»·ç³»ç»Ÿå¼€å‘

### ğŸ” å½“å‰çŠ¶æ€åˆ†æ
- æ•°æ®åº“è¡¨sys_evaluationå·²è®¾è®¡å®Œæˆ
- å®Œå…¨æ²¡æœ‰ç›¸å…³çš„Controllerã€Serviceã€Mapper
- å‰ç«¯è¯„ä»·é¡µé¢æœªå¼€å‘

### âœ… å…·ä½“å®æ–½æ­¥éª¤

#### 1. åç«¯è¯„ä»·æ¥å£å¼€å‘ï¼ˆ2å¤©ï¼‰

##### 1.1 åˆ›å»ºå®ä½“ç±»å’ŒDTO
```java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/entity/Evaluation.java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/dto/EvaluationSaveDTO.java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/dto/EvaluationQueryDTO.java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/vo/EvaluationVO.java
```

##### 1.2 åˆ›å»ºMapperæ¥å£
```java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/mapper/EvaluationMapper.java
public interface EvaluationMapper extends BaseMapper<Evaluation> {
    // æŸ¥è¯¢è¾¾äººè¯„ä»·åˆ—è¡¨
    IPage<EvaluationVO> selectEvaluationPage(Page<EvaluationVO> page, EvaluationQueryDTO queryDTO);
    
    // è®¡ç®—è¾¾äººå¹³å‡è¯„åˆ†
    BigDecimal calculateExpertRating(Long expertId);
    
    // è·å–è¯„ä»·ç»Ÿè®¡
    EvaluationStatsVO getEvaluationStats(Long expertId);
}
```

##### 1.3 åˆ›å»ºServiceæ¥å£å’Œå®ç°
```java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/service/EvaluationService.java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/service/impl/EvaluationServiceImpl.java

public interface EvaluationService extends IService<Evaluation> {
    // æäº¤è¯„ä»·
    Boolean submitEvaluation(EvaluationSaveDTO saveDTO);
    
    // è·å–è¾¾äººè¯„ä»·åˆ—è¡¨
    IPage<EvaluationVO> getEvaluationPage(EvaluationQueryDTO queryDTO);
    
    // è·å–è¯„ä»·è¯¦æƒ…
    EvaluationVO getEvaluationDetail(Long evaluationId);
    
    // è¾¾äººå›å¤è¯„ä»·
    Boolean replyEvaluation(Long evaluationId, String replyContent);
    
    // æ›´æ–°è¾¾äººè¯„åˆ†
    Boolean updateExpertRating(Long expertId);
}
```

##### 1.4 åˆ›å»ºController
```java
// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/controller/api/EvaluationController.java
// ç”¨æˆ·ç«¯è¯„ä»·æ¥å£

// æ–‡ä»¶ï¼šexpert/src/main/java/com/qing/expert/controller/admin/AdminEvaluationController.java
// ç®¡ç†ç«¯è¯„ä»·æ¥å£
```

#### 2. å‰ç«¯è¯„ä»·åŠŸèƒ½å¼€å‘ï¼ˆ2å¤©ï¼‰

##### 2.1 å°ç¨‹åºç«¯è¯„ä»·åŠŸèƒ½
```vue
<!-- æ–‡ä»¶ï¼šuniapp/Uni_expert/pages/order/evaluate.vue -->
<!-- è®¢å•è¯„ä»·æäº¤é¡µé¢ -->

<!-- æ–‡ä»¶ï¼šuniapp/Uni_expert/pages/expert/evaluations.vue -->
<!-- è¾¾äººè¯„ä»·å±•ç¤ºé¡µé¢ -->

<!-- æ–‡ä»¶ï¼šuniapp/Uni_expert/pages/user/my-evaluations.vue -->
<!-- æˆ‘çš„è¯„ä»·è®°å½•é¡µé¢ -->
```

##### 2.2 ç®¡ç†ç«¯è¯„ä»·åŠŸèƒ½
```vue
<!-- æ–‡ä»¶ï¼šweb/src/views/evaluations/index.vue -->
<!-- è¯„ä»·ç®¡ç†åˆ—è¡¨é¡µé¢ -->

<!-- æ–‡ä»¶ï¼šweb/src/views/evaluations/detail.vue -->
<!-- è¯„ä»·è¯¦æƒ…é¡µé¢ -->
```

#### 3. è¯„ä»·ä¸šåŠ¡é€»è¾‘å®Œå–„ï¼ˆ1å¤©ï¼‰

##### 3.1 è®¢å•å®Œæˆåè¯„ä»·æé†’
```java
// åœ¨OrderServiceImpl.finishOrder()æ–¹æ³•ä¸­æ·»åŠ è¯„ä»·æé†’é€»è¾‘
// å‘é€è¯„ä»·æé†’æ¶ˆæ¯
```

##### 3.2 è¯„ä»·å†…å®¹å®¡æ ¸
```java
// æ·»åŠ æ•æ„Ÿè¯è¿‡æ»¤
// æ·»åŠ è¯„ä»·å†…å®¹é•¿åº¦é™åˆ¶
// æ·»åŠ å›¾ç‰‡å†…å®¹å®¡æ ¸
```

##### 3.3 é˜²é‡å¤è¯„ä»·æœºåˆ¶
```java
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å¯¹è¯¥è®¢å•è¯„ä»·
// æ·»åŠ å”¯ä¸€ç´¢å¼•çº¦æŸ
```

## ğŸ“… æ—¶é—´å®‰æ’

### ç¬¬1å¤©ï¼šæ”¯ä»˜åŠŸèƒ½æ¸…ç†
- âœ… ä¸Šåˆï¼šç§»é™¤æ”¯ä»˜å®æ”¯ä»˜åç«¯ä»£ç 
- âœ… ä¸‹åˆï¼šæ¸…ç†å‰ç«¯æ”¯ä»˜å®æ”¯ä»˜ç›¸å…³ä»£ç 

### ç¬¬2-3å¤©ï¼šå¾®ä¿¡æ”¯ä»˜å›è°ƒå®Œå–„
- âœ… ç¬¬2å¤©ï¼šå®ç°å›è°ƒéªŒè¯å’ŒçŠ¶æ€åŒæ­¥é€»è¾‘
- âœ… ç¬¬3å¤©ï¼šæ·»åŠ å¼‚å¸¸å¤„ç†å’Œæµ‹è¯•éªŒè¯

### ç¬¬4-7å¤©ï¼šè¯„ä»·ç³»ç»Ÿå¼€å‘
- âœ… ç¬¬4å¤©ï¼šåç«¯å®ä½“ç±»ã€Mapperã€Serviceå¼€å‘
- âœ… ç¬¬5å¤©ï¼šåç«¯Controlleræ¥å£å¼€å‘
- âœ… ç¬¬6å¤©ï¼šå°ç¨‹åºç«¯è¯„ä»·åŠŸèƒ½å¼€å‘
- âœ… ç¬¬7å¤©ï¼šç®¡ç†ç«¯è¯„ä»·åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘å®Œå–„

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### æ”¯ä»˜åŠŸèƒ½æ¸…ç†
- [ ] ä»£ç ä¸­ä¸å†åŒ…å«æ”¯ä»˜å®æ”¯ä»˜ç›¸å…³é€»è¾‘
- [ ] å‰ç«¯æ”¯ä»˜é¡µé¢åªæ˜¾ç¤ºå¾®ä¿¡æ”¯ä»˜å’Œä½™é¢æ”¯ä»˜
- [ ] æ”¯ä»˜æµç¨‹æµ‹è¯•æ­£å¸¸

### å¾®ä¿¡æ”¯ä»˜å›è°ƒ
- [ ] å›è°ƒæ¥å£èƒ½æ­£ç¡®éªŒè¯å¾®ä¿¡ç­¾å
- [ ] æ”¯ä»˜æˆåŠŸåè®¢å•çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] æ”¯ä»˜å¤±è´¥æƒ…å†µæ­£ç¡®å¤„ç†
- [ ] å›è°ƒæ—¥å¿—è®°å½•å®Œæ•´

### è¯„ä»·ç³»ç»Ÿ
- [ ] ç”¨æˆ·å¯ä»¥å¯¹å®Œæˆçš„è®¢å•è¿›è¡Œè¯„ä»·
- [ ] è¾¾äººè¯„åˆ†èƒ½å¤Ÿå®æ—¶æ›´æ–°
- [ ] ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è¯„ä»·
- [ ] è¯„ä»·å†…å®¹è¿‡æ»¤æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] é˜²é‡å¤è¯„ä»·æœºåˆ¶æœ‰æ•ˆ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¾®ä¿¡æ”¯ä»˜æµ‹è¯•**ï¼šéœ€è¦é…ç½®çœŸå®çš„å•†æˆ·å·å’Œè¯ä¹¦
2. **æ•°æ®åº“å˜æ›´**ï¼šè¯„ä»·ç³»ç»Ÿå¯èƒ½éœ€è¦è°ƒæ•´æ•°æ®åº“è¡¨ç»“æ„
3. **å‰ç«¯é€‚é…**ï¼šç¡®ä¿å°ç¨‹åºç«¯å’Œç®¡ç†ç«¯ç•Œé¢é€‚é…
4. **æ€§èƒ½è€ƒè™‘**ï¼šè¯„ä»·æŸ¥è¯¢éœ€è¦è€ƒè™‘åˆ†é¡µå’Œç´¢å¼•ä¼˜åŒ–
5. **å®‰å…¨é˜²æŠ¤**ï¼šè¯„ä»·å†…å®¹éœ€è¦é˜²æ­¢XSSæ”»å‡»å’Œæ•æ„Ÿè¯è¿‡æ»¤
