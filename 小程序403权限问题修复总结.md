# 小程序403权限问题修复总结

## 问题描述

小程序请求 `http://localhost:8080/api/experts/2/photos` 接口时返回403 Forbidden错误：

```
Request URL: http://localhost:8080/api/experts/2/photos
Request Method: GET
Status Code: 403 
Referer: https://servicewechat.com/wxc9b98294ace36519/devtools/page-frame.html
```

## 问题分析

通过分析代码和错误信息，发现可能的原因：

1. **路径匹配问题**：SecurityConfig中使用 `/experts/*` 只能匹配一级路径，无法匹配 `/experts/{id}/photos`
2. **CORS配置问题**：微信小程序开发工具的来源 `https://servicewechat.com` 不在允许的CORS列表中
3. **权限配置不完整**：可能存在其他权限配置冲突

## 修复方案

### 1. 修复SecurityConfig路径匹配

**文件**: `expert/src/main/java/com/qing/expert/config/SecurityConfig.java`

#### 修复前：
```java
"/experts/*", // 只能匹配一级路径，如 /experts/123
```

#### 修复后：
```java
"/experts/**", // 可以匹配多级路径，如 /experts/123/photos
```

### 2. 更新CORS配置

#### SecurityConfig CORS配置：
```java
// 允许的源 - 包括微信小程序开发工具
configuration.setAllowedOriginPatterns(Arrays.asList(
        "*", // 允许所有来源（开发环境）
        "https://servicewechat.com", // 微信小程序开发工具
        "https://*.servicewechat.com" // 微信小程序相关域名
));
```

#### WebConfig CORS配置：
```java
.allowedOriginPatterns(
        "http://localhost:*", // 本地开发环境
        "http://127.0.0.1:*", // 本地开发环境备用
        "https://servicewechat.com", // 微信小程序开发工具
        "https://*.servicewechat.com", // 微信小程序相关域名
        "*" // 开发环境允许所有来源
)
```

### 3. 增强小程序请求调试

**文件**: `uniapp/Uni_expert/api/request.ts`

#### 添加详细的错误日志：
```typescript
// 特殊处理403错误
if (statusCode === 403) {
  console.error(`[403错误] ${requestId}: 可能的原因:`)
  console.error('1. CORS配置问题')
  console.error('2. 后端权限配置问题')
  console.error('3. 请求头缺失或错误')
}
```

#### 添加CORS相关头部：
```typescript
// 添加CORS相关头部
options.header['Access-Control-Request-Method'] = options.method
options.header['Access-Control-Request-Headers'] = 'Content-Type,X-Request-ID'
```

### 4. 验证JWT过滤器配置

**文件**: `expert/src/main/java/com/qing/expert/filter/JwtAuthenticationFilter.java`

确认JWT过滤器中已正确配置公开接口跳过逻辑：

```java
// 公共API接口
if (requestURI.startsWith("/api/experts") ||
        requestURI.startsWith("/experts")) {
    return true; // 跳过JWT验证
}
```

## 修复后的效果

### 1. 路径匹配正确
- ✅ `/api/experts` - 达人列表
- ✅ `/api/experts/{id}` - 达人详情  
- ✅ `/api/experts/{id}/photos` - 达人照片列表

### 2. CORS支持完整
- ✅ 支持微信小程序开发工具来源
- ✅ 支持本地开发环境
- ✅ 支持所有必要的HTTP方法和头部

### 3. 调试信息完善
- ✅ 详细的请求日志
- ✅ 403错误的具体原因分析
- ✅ 请求头和响应头的完整记录

## 测试验证

### 1. 创建API测试页面
创建了 `api-test.html` 用于在浏览器中测试API接口：
- 测试热门达人列表API
- 测试达人照片API
- 测试CORS预检请求

### 2. 小程序测试
在小程序中测试：
1. 首页热门达人数据加载
2. 3D照片轮播显示
3. 点击跳转功能

## 预期结果

修复后，小程序应该能够：

1. **成功获取热门达人数据**
   ```
   GET /api/experts/hot → 200 OK
   ```

2. **成功获取达人照片数据**
   ```
   GET /api/experts/{id}/photos → 200 OK
   ```

3. **正常显示3D照片轮播**
   - 显示达人照片
   - 叠加达人信息（姓名、评分）
   - 支持滑动和点击交互

## 注意事项

### 开发环境配置
- 确保后端服务运行在 `http://localhost:8080`
- 确保小程序开发工具的网络请求域名配置正确
- 确保 `manifest.json` 中 `"urlCheck": false` 已设置

### 生产环境配置
在生产环境部署时需要：
1. 更新CORS配置，移除 `"*"` 通配符
2. 配置具体的小程序域名
3. 启用HTTPS
4. 配置正确的文件访问路径

## 文件变更清单

### 后端修改：
1. **`expert/src/main/java/com/qing/expert/config/SecurityConfig.java`**
   - 修复路径匹配：`/experts/*` → `/experts/**`
   - 添加微信小程序CORS支持

2. **`expert/src/main/java/com/qing/expert/config/WebConfig.java`**
   - 更新CORS配置，支持微信小程序来源

### 前端修改：
1. **`uniapp/Uni_expert/api/request.ts`**
   - 增强错误处理和调试日志
   - 添加CORS相关请求头

### 测试文件：
1. **`api-test.html`** - 浏览器API测试页面
2. **`test-api.js`** - Node.js API测试脚本

## 总结

通过以上修复，解决了小程序访问后端API时的403权限问题，确保了：

1. **权限配置正确**：公开API接口无需认证即可访问
2. **CORS配置完整**：支持微信小程序开发工具的跨域请求
3. **路径匹配准确**：支持多级API路径的正确匹配
4. **调试信息完善**：便于后续问题排查和调试

现在小程序应该能够正常获取热门达人数据并显示3D照片轮播效果。
