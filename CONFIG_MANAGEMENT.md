# 配置管理指南

## 配置分层策略

本项目采用分层配置管理策略，明确区分不同类型配置的存储位置和管理方式。

## 配置分类

### 1. 环境变量配置 (.env文件)

**适用场景**：基础设施、安全、环境相关配置

**包含配置**：
- 数据库连接配置 (DB_HOST, DB_PORT, DB_USERNAME, DB_PASSWORD)
- Redis连接配置 (REDIS_HOST, REDIS_PORT, REDIS_PASSWORD)
- JWT安全配置 (JWT_SECRET, JWT_EXPIRATION)
- 服务器配置 (SERVER_PORT)
- 日志配置 (LOG_LEVEL, LOG_FILE_ENABLED)
- 前端构建配置 (VITE_*)

**特点**：
- 部署时配置，运行时不可修改
- 涉及安全敏感信息
- 环境相关差异较大

### 2. 数据库配置 (system_configs表)

**适用场景**：业务配置、功能开关、可动态修改的配置

**包含配置**：
- 微信小程序配置 (AppID, Secret, Token)
- 微信支付配置 (商户号, API密钥, 证书路径)
- 阿里云OSS配置 (端点, 访问密钥, 存储桶)
- 业务规则配置 (平台抽成比例, 最小提现金额)
- 系统信息配置 (系统名称, Logo, 联系方式)
- 功能开关 (支付开关, 存储类型选择)

**特点**：
- 可通过管理后台动态修改
- 支持热更新，无需重启服务
- 业务人员可直接管理
- 支持配置历史和审计

## 配置优先级

1. **环境变量** (最高优先级)
2. **数据库配置** (中等优先级)  
3. **代码默认值** (最低优先级)

## 配置访问方式

### 环境变量配置
```java
// 通过@Value注解或Environment获取
@Value("${DB_HOST:localhost}")
private String dbHost;
```

### 数据库配置
```java
// 通过SystemConfigService获取
@Autowired
private SystemConfigService configService;

String appId = configService.getConfigValue("wechat_miniapp_app_id");
```

## 配置管理界面

### 访问路径
- 管理后台 -> 系统管理 -> 系统配置

### 配置分组
- **微信配置**: 小程序和支付相关配置
- **存储配置**: 文件存储和OSS配置  
- **系统配置**: 系统基本信息配置
- **业务配置**: 业务规则和参数配置

## 配置修改流程

### 环境变量配置修改
1. 修改 `.env` 文件
2. 重启应用服务
3. 验证配置生效

### 数据库配置修改
1. 登录管理后台
2. 进入系统配置页面
3. 选择对应配置分组
4. 修改配置值
5. 保存配置（立即生效）

## 安全注意事项

### 敏感配置保护
- JWT密钥、数据库密码等敏感信息存储在环境变量中
- 数据库中的敏感配置支持加密存储
- 生产环境配置文件不应提交到版本控制

### 配置验证
- 关键配置修改前进行有效性验证
- 支持配置回滚机制
- 记录配置修改日志

## 最佳实践

### 开发环境
- 使用本地 `.env` 文件进行环境配置
- 数据库配置使用测试数据
- 启用调试模式和详细日志

### 生产环境  
- 环境变量通过部署脚本或容器环境设置
- 数据库配置使用真实的生产配置
- 关闭调试模式，设置适当的日志级别

### 配置同步
- 开发环境数据库配置应与生产环境保持结构一致
- 新增配置项时同步更新数据库初始化脚本
- 定期备份重要配置数据

## 故障排除

### 配置不生效
1. 检查配置优先级是否正确
2. 验证环境变量是否正确设置
3. 确认数据库配置是否正确保存
4. 检查应用是否正确重启

### 配置冲突
1. 确认同一配置项只在一个地方维护
2. 检查环境变量和数据库配置的一致性
3. 验证配置读取逻辑是否正确

### 权限问题
1. 确认管理员账户有配置修改权限
2. 检查配置接口的权限控制
3. 验证前端路由和API权限配置
